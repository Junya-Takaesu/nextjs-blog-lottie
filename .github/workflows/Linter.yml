name: Lint

on:
  pull_request:
    types: [opened, reopened, synchronize]
    paths:
      - "**.ts"
      - "**.tsx"
      - "**.js"
      - "**.jsx"
      - "package.json"
      - "yarn.lock"
    branches: [main, develop]

permissions:
  pull-requests: write
  contents: read

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        id: eslint
        continue-on-error: true
        run: |
          # ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç¶šè¡Œ
          set +e

          npx next lint --format json --output-file lint_output.json
          LINT_EXIT_CODE=$?

          # ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã‚’ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦ä¿å­˜
          # echo "LINT_EXIT_CODE=${LINT_EXIT_CODE}" >> $GITHUB_ENV

          if [ -s lint_output.json ]; then
            # çµ±è¨ˆæƒ…å ±ã‚’é›†è¨ˆ
            STATS=$(jq -r '
              reduce .[] as $file (
                {"error": 0, "warning": 0};
                .error += $file.errorCount |
                .warning += $file.warningCount
              )
            ' lint_output.json)

            echo "TOTAL_ERRORS=$(echo $STATS | jq -r '.error')" >> $GITHUB_ENV
            echo "TOTAL_WARNINGS=$(echo $STATS | jq -r '.warning')" >> $GITHUB_ENV
          else
            echo "TOTAL_ERRORS=0" >> $GITHUB_ENV
            echo "TOTAL_WARNINGS=0" >> $GITHUB_ENV
          fi

          # next lint ã®å®Ÿè¡Œçµæœã«åŸºã¥ã„ã¦ã‚¹ãƒ†ãƒƒãƒ—ã®æˆåŠŸ/å¤±æ•—ã‚’æ±ºå®š
          exit $LINT_EXIT_CODE

      - name: Comment PR
        run: |
          ERRORS=${TOTAL_ERRORS:-0}
          WARNINGS=${TOTAL_WARNINGS:-0}
          TOTAL=$((ERRORS + WARNINGS))

          if [ $TOTAL -eq 0 ]; then
            STATUS="âœ… All Clear"
            SUMMARY="âœ¨ Excellent! No linting issues found."
          else
            if [ $ERRORS -gt 0 ]; then
              STATUS="âŒ Failed"
            else
              STATUS="âš ï¸ Passed with warnings"
            fi
            SUMMARY="ğŸ“Š Summary:
            - ğŸ”´ Errors: $ERRORS
            - âš ï¸ Warnings: $WARNINGS
            - ğŸ“ Total Issues: $TOTAL"
          fi

          CURRENT_TIME=$(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S')

          BODY=$(cat <<EOF
          ## ESLint Check Results

          ### Status: $STATUS

          $SUMMARY

          [View detailed log](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID})

          *Executed at: $CURRENT_TIME*
          EOF
          )

          gh auth token
          gh pr comment ${{ github.event.pull_request.number }} --body "$BODY"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
